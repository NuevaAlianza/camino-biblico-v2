<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mi Perfil – Camino Bíblico</title>
  <link rel="stylesheet" href="css/estilos.css" />
  <style>
    body { font-family: Arial, sans-serif; max-width: 420px; margin: 2rem auto; padding: 1.5rem; }
    h2 { margin-bottom: 1.5rem; }
    label { font-weight: bold; }
    input, select { display: block; width: 100%; margin-bottom: 1.2rem; padding: 0.65em 0.5em; font-size: 1em; }
    button { padding: 0.6em 1.3em; }
    .mensaje { margin-bottom: 1.2rem; color: #168; font-weight: bold; }
    .error { color: #b30000; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="supabase.js"></script>
</head>
<body>
  <h2>Editar Perfil</h2>
  <div class="mensaje" id="mensaje"></div>
  <form id="perfil-form">
    <label for="nombre">Nombre</label>
    <input type="text" id="nombre" required />
    <label for="parroquia">Parroquia</label>
    <select id="parroquia" required>
      <option value="">-- Elige tu parroquia --</option>
    </select>
    <label for="subgrupo">Subgrupo</label>
    <select id="subgrupo" required>
      <option value="">-- Elige un subgrupo --</option>
    </select>
    <button type="submit">Guardar Cambios</button>
  </form>
  <a href="menu.html">← Volver al menú</a>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  let parroquias = [];
  let subgrupos = [];
  const parroquiaSelect = document.getElementById('parroquia');
  const subgrupoSelect = document.getElementById('subgrupo');
  const mensajeDiv = document.getElementById('mensaje');

  // Cargar sesión y metadatos
  const { data: sessionData } = await supabase.auth.getSession();
  const user = sessionData?.session?.user;
  if (!user) {
    mensajeDiv.textContent = "Debes iniciar sesión para editar tu perfil.";
    mensajeDiv.className = "mensaje error";
    document.getElementById('perfil-form').style.display = "none";
    return;
  }
  const meta = user.user_metadata || {};

  // 1. Cargar parroquias
  const { data: parroquiasData, error: errorParroquias } = await supabase
    .from("parroquias")
    .select("id, nombre_mostrar, ciudad_mostrar, pais_mostrar")
    .order("nombre_mostrar", { ascending: true });
  if (errorParroquias || !parroquiasData) {
    mensajeDiv.textContent = "No se pudieron cargar las parroquias.";
    mensajeDiv.className = "mensaje error";
    return;
  }
  parroquias = parroquiasData;
  parroquias.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = `${p.nombre_mostrar} (${p.ciudad_mostrar}, ${p.pais_mostrar})`;
    parroquiaSelect.appendChild(opt);
  });

  // 2. Rellenar nombre y parroquia actuales
  document.getElementById('nombre').value = meta.nombre || "";
  if (meta.parroquia) {
    const actual = parroquias.find(p => 
      p.nombre_mostrar.toLowerCase() === meta.parroquia.toLowerCase()
    );
    if (actual) parroquiaSelect.value = actual.id;
  }

  // 3. Función para cargar subgrupos segun parroquia seleccionada
  async function cargarSubgrupos(parroquiaId, subgrupoPrevio = null) {
    subgrupoSelect.innerHTML = '<option value="">-- Elige un subgrupo --</option>';
    if (!parroquiaId) return;
    const { data: subgruposData, error: errorSub } = await supabase
      .from("subgrupos")
      .select("id, nombre")
      .eq("parroquia_id", parroquiaId)
      .order("nombre", { ascending: true });
    if (errorSub) {
      subgrupoSelect.innerHTML = '<option value="">(Error cargando subgrupos)</option>';
      return;
    }
    subgrupos = subgruposData;
    subgrupos.forEach(sg => {
      const opt = document.createElement('option');
      opt.value = sg.id;
      opt.textContent = sg.nombre;
      subgrupoSelect.appendChild(opt);
    });
    // Selecciona el subgrupo si está guardado en perfil
    if (subgrupoPrevio) {
      const encontrado = subgrupos.find(sg => String(sg.id) === String(subgrupoPrevio));
      if (encontrado) subgrupoSelect.value = encontrado.id;
    }
  }

  // 4. Al cambiar parroquia, cargar subgrupos
  parroquiaSelect.addEventListener('change', e => {
    cargarSubgrupos(e.target.value);
  });

  // 5. Al cargar, también carga subgrupo guardado (si existe)
  let subgrupoPrevio = null;
  if (meta.subgrupo) subgrupoPrevio = meta.subgrupo;
  if (parroquiaSelect.value) cargarSubgrupos(parroquiaSelect.value, subgrupoPrevio);

  // 6. Guardar cambios
  document.getElementById('perfil-form').onsubmit = async e => {
    e.preventDefault();
    mensajeDiv.textContent = "";
    const nombre = document.getElementById('nombre').value.trim();
    const parroquiaId = parroquiaSelect.value;
    const parroquiaObj = parroquias.find(p => p.id == parroquiaId);
    const parroquiaNombre = parroquiaObj ? parroquiaObj.nombre_mostrar : "";
    const parroquiaCiudad = parroquiaObj ? parroquiaObj.ciudad_mostrar : "";
    const parroquiaPais = parroquiaObj ? parroquiaObj.pais_mostrar : "";
    const subgrupoId = subgrupoSelect.value;
    const subgrupoObj = subgrupos.find(sg => String(sg.id) === String(subgrupoId));
    const subgrupoNombre = subgrupoObj ? subgrupoObj.nombre : "";

    // Actualiza metadatos en Auth
    let { error: errorMeta } = await supabase.auth.updateUser({
      data: {
        nombre,
        parroquia: parroquiaNombre,
        ciudad: parroquiaCiudad,
        pais: parroquiaPais,
        subgrupo: subgrupoId
      }
    });

    // Actualiza tabla usuarios
    let { error: errorUsuario } = await supabase
      .from('usuarios')
      .upsert([{
        id: user.id,
        email: user.email,
        nombre: nombre,
        pais: parroquiaPais,
        ciudad: parroquiaCiudad,
        parroquia: parroquiaNombre,
        subgrupo: subgrupoId
      }], { onConflict: ['id'] });

    if (errorMeta || errorUsuario) {
      mensajeDiv.textContent = "Error al actualizar: " + (errorMeta?.message || "") + (errorUsuario?.message || "");
      mensajeDiv.className = "mensaje error";
    } else {
      mensajeDiv.textContent = "¡Perfil actualizado!";
      mensajeDiv.className = "mensaje";
    }
  };

});
</script>
</body>
</html>
