<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mi Perfil – Camino Bíblico</title>
  <link rel="stylesheet" href="css/estilos.css" />
  <style>
    body { font-family: Arial, sans-serif; max-width: 420px; margin: 2rem auto; padding: 1.5rem; }
    h2 { margin-bottom: 1.5rem; }
    label { font-weight: bold; }
    input, select { display: block; width: 100%; margin-bottom: 1.2rem; padding: 0.65em 0.5em; font-size: 1em; }
    button { padding: 0.6em 1.3em; }
    .mensaje { margin-bottom: 1.2rem; color: #168; font-weight: bold; }
    .error { color: #b30000; }
    input[readonly] { background: #f2f2f2; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="supabase.js"></script>
</head>
<body>
  <h2>Editar Perfil</h2>
  <div class="mensaje" id="mensaje"></div>
  <form id="perfil-form">
    <label for="nombre">Nombre</label>
    <input type="text" id="nombre" readonly />

    <label for="parroquia">Parroquia</label>
    <select id="parroquia" required>
      <option value="">-- Elige tu parroquia --</option>
    </select>

    <label for="ciudad">Ciudad</label>
    <input type="text" id="ciudad" readonly />

    <label for="pais">País</label>
    <input type="text" id="pais" readonly />

    <label for="subgrupo">Subgrupo</label>
    <select id="subgrupo" required disabled>
      <option value="">-- Elige un subgrupo --</option>
    </select>

    <button type="submit">Guardar Cambios</button>
  </form>
  <a href="menu.html">← Volver al menú</a>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  let parroquias = [];
  let subgrupos = [];
  const parroquiaSelect = document.getElementById('parroquia');
  const subgrupoSelect = document.getElementById('subgrupo');
  const mensajeDiv = document.getElementById('mensaje');
  const ciudadInput = document.getElementById('ciudad');
  const paisInput = document.getElementById('pais');
  const nombreInput = document.getElementById('nombre');

  // --- Obtener sesión y usuario actual ---
  const { data: sessionData } = await supabase.auth.getSession();
  const user = sessionData?.session?.user;
  if (!user) {
    mensajeDiv.textContent = "Debes iniciar sesión para editar tu perfil.";
    mensajeDiv.className = "mensaje error";
    document.getElementById('perfil-form').style.display = "none";
    return;
  }
  const meta = user.user_metadata || {};

  // --- 1. Cargar parroquias desde BD ---
  let { data: parroquiasData, error: parroquiasError } = await supabase
    .from("parroquias")
    .select("id, nombre_mostrar, ciudad_mostrar, pais_mostrar")
    .order("nombre_mostrar", { ascending: true });
  if (parroquiasError || !parroquiasData) {
    mensajeDiv.textContent = "No se pudieron cargar las parroquias.";
    mensajeDiv.className = "mensaje error";
    return;
  }
  parroquias = parroquiasData;
  parroquias.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = `${p.nombre_mostrar} (${p.ciudad_mostrar}, ${p.pais_mostrar})`;
    parroquiaSelect.appendChild(opt);
  });

  // --- 2. Cargar subgrupos desde BD (todos) ---
  let { data: subgruposData, error: subgruposError } = await supabase
    .from("subgrupos")
    .select("id, nombre, parroquia_id");
  if (subgruposError || !subgruposData) {
    mensajeDiv.textContent = "No se pudieron cargar los subgrupos.";
    mensajeDiv.className = "mensaje error";
    return;
  }
  subgrupos = subgruposData;

  // --- 3. Rellenar datos del usuario actual ---
  let { data: usuarioData } = await supabase
    .from("usuarios")
    .select("nombre, parroquia, ciudad, pais, subgrupo")
    .eq("id", user.id)
    .maybeSingle();

  nombreInput.value = usuarioData?.nombre || meta.nombre || "";

  if (usuarioData?.parroquia) {
    // Busca el id de la parroquia por nombre
    parroquiaSelect.value = parroquias.find(p => p.nombre_mostrar === usuarioData.parroquia)?.id || "";
    // Rellenar ciudad y país según parroquia seleccionada
    const parroquiaSel = parroquias.find(p => String(p.id) === String(parroquiaSelect.value));
    if (parroquiaSel) {
      ciudadInput.value = parroquiaSel.ciudad_mostrar;
      paisInput.value = parroquiaSel.pais_mostrar;
    }
    cargarSubgrupos(parroquiaSelect.value, usuarioData.subgrupo);
  }

  parroquiaSelect.addEventListener('change', (e) => {
    const parroquiaId = e.target.value;
    const parroquiaSel = parroquias.find(p => String(p.id) === String(parroquiaId));
    ciudadInput.value = parroquiaSel ? parroquiaSel.ciudad_mostrar : "";
    paisInput.value = parroquiaSel ? parroquiaSel.pais_mostrar : "";
    cargarSubgrupos(parroquiaId, null);
  });

  function cargarSubgrupos(parroquiaId, subgrupoIdSeleccionado) {
    subgrupoSelect.innerHTML = '<option value="">-- Elige un subgrupo --</option>';
    if (!parroquiaId) {
      subgrupoSelect.disabled = true;
      return;
    }
    const subgruposFiltrados = subgrupos.filter(sg => String(sg.parroquia_id) === String(parroquiaId));
    subgruposFiltrados.forEach(sg => {
      const opt = document.createElement('option');
      opt.value = sg.id; // aquí value es el id numérico (int4)
      opt.textContent = sg.nombre;
      subgrupoSelect.appendChild(opt);
    });
    subgrupoSelect.disabled = subgruposFiltrados.length === 0;
    if (subgrupoIdSeleccionado) {
      // Aquí selecciona el ID numérico guardado (int4)
      subgrupoSelect.value = subgrupoIdSeleccionado;
    }
  }

  // --- 4. Guardar cambios ---
  document.getElementById('perfil-form').onsubmit = async e => {
    e.preventDefault();
    mensajeDiv.textContent = "";

    const parroquiaId = parroquiaSelect.value;
    const subgrupoId = subgrupoSelect.value;

    // Busca los nombres según el ID seleccionado
    const parroquiaObj = parroquias.find(p => String(p.id) === String(parroquiaId));
    const parroquiaNombre = parroquiaObj ? parroquiaObj.nombre_mostrar : "";
    const ciudad = parroquiaObj ? parroquiaObj.ciudad_mostrar : "";
    const pais = parroquiaObj ? parroquiaObj.pais_mostrar : "";

    // Busca el nombre del subgrupo por id
    const subgrupoObj = subgrupos.find(sg => String(sg.id) === String(subgrupoId));
    const subgrupoNombre = subgrupoObj ? subgrupoObj.nombre : "";

    if (!parroquiaNombre || !subgrupoId) {
      mensajeDiv.textContent = "Selecciona parroquia y subgrupo.";
      mensajeDiv.className = "mensaje error";
      return;
    }

    // Actualiza metadatos en Auth (opcional)
    let { error: errorMeta } = await supabase.auth.updateUser({
      data: {
        parroquia: parroquiaNombre,
        ciudad: ciudad,
        pais: pais,
        subgrupo: subgrupoId // puedes guardar el id aquí o el nombre si prefieres
      }
    });

    // Guarda el nombre de parroquia (text) y el id de subgrupo (int4) en la tabla usuarios
    let { error: errorUsuario } = await supabase
      .from('usuarios')
      .upsert([{
        id: user.id,
        email: user.email,
        nombre: nombreInput.value,
        parroquia: parroquiaNombre, // ← SOLO NOMBRE (text)
        ciudad: ciudad,
        pais: pais,
        subgrupo: parseInt(subgrupoId, 10) // ← SOLO ID (int4)
      }], { onConflict: ['id'] });

    if (errorMeta || errorUsuario) {
      mensajeDiv.textContent = "Error al actualizar: " + (errorMeta?.message || "") + (errorUsuario?.message || "");
      mensajeDiv.className = "mensaje error";
    } else {
      mensajeDiv.textContent = "¡Perfil actualizado!";
      mensajeDiv.className = "mensaje";
    }
  };

});
</script>
</body>
</html>
